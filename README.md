# API REST con CI/CD Completo

[![CI/CD Pipeline](https://github.com/jpalenz77/practica-final-cicd/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/jpalenz77/practica-final-cicd/actions)
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=jpalenz77_practica-final-cicd&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=jpalenz77_practica-final-cicd)

[![Node.js](https://img.shields.io/badge/Node.js-18+-339933?style=flat-square&logo=node.js&logoColor=white)](https://nodejs.org/)
[![Express](https://img.shields.io/badge/Express-4.18+-000000?style=flat-square&logo=express&logoColor=white)](https://expressjs.com/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=flat-square&logo=docker&logoColor=white)](https://www.docker.com/)
[![Kubernetes](https://img.shields.io/badge/Kubernetes-326CE5?style=flat-square&logo=kubernetes&logoColor=white)](https://kubernetes.io/)
[![ArgoCD](https://img.shields.io/badge/ArgoCD-EF7B4D?style=flat-square&logo=argo&logoColor=white)](https://argo-cd.readthedocs.io/)

[![GitHub Actions](https://img.shields.io/badge/GitHub_Actions-2088FF?style=flat-square&logo=github-actions&logoColor=white)](https://github.com/features/actions)
[![SonarCloud](https://img.shields.io/badge/SonarCloud-F3702A?style=flat-square&logo=sonarcloud&logoColor=white)](https://sonarcloud.io/)
[![Snyk](https://img.shields.io/badge/Snyk-4C4A73?style=flat-square&logo=snyk&logoColor=white)](https://snyk.io/)
[![Jest](https://img.shields.io/badge/Jest-C21325?style=flat-square&logo=jest&logoColor=white)](https://jestjs.io/)
[![ESLint](https://img.shields.io/badge/ESLint-4B32C3?style=flat-square&logo=eslint&logoColor=white)](https://eslint.org/)

API REST desarrollada con Node.js y Express que implementa un pipeline completo de CI/CD con despliegue autom√°tico en Kubernetes usando ArgoCD y pr√°cticas GitOps.

---

## üìã Tabla de Contenidos

- [üöÄ Caracter√≠sticas](#-caracter√≠sticas)
- [üîß Requisitos Previos](#-requisitos-previos)
- [‚öôÔ∏è Instalaci√≥n y Configuraci√≥n](#Ô∏è-instalaci√≥n-y-configuraci√≥n)
- [üåê Configuraci√≥n de Servicios Externos](#-configuraci√≥n-de-servicios-externos)
- [üîê Configuraci√≥n de GitHub Secrets](#-configuraci√≥n-de-github-secrets)
- [‚ò∏Ô∏è Configuraci√≥n del Cluster Kubernetes](#Ô∏è-configuraci√≥n-del-cluster-kubernetes)
- [üîÑ Configuraci√≥n de ArgoCD](#-configuraci√≥n-de-argocd)
- [üìö API Endpoints](#-api-endpoints)
- [üîÑ CI/CD Pipeline](#-cicd-pipeline)
- [üîÑ Flujo de Trabajo GitOps](#-flujo-de-trabajo-gitops)
- [‚úÖ Verificaci√≥n Completa](#-verificaci√≥n-completa)
- [üèóÔ∏è Arquitectura](#Ô∏è-arquitectura)
- [üìÅ Estructura del Proyecto](#-estructura-del-proyecto)
- [üîß Troubleshooting](#-troubleshooting)
- [üîó Enlaces Importantes](#-enlaces-importantes)
- [üë• Autor](#-autor)

---

## üöÄ Caracter√≠sticas

- ‚úÖ API REST completa con CRUD de usuarios
- ‚úÖ Tests unitarios con Jest (cobertura >70%)
- ‚úÖ Linting con ESLint
- ‚úÖ An√°lisis est√°tico de c√≥digo con SonarCloud
- ‚úÖ An√°lisis de vulnerabilidades con Snyk
- ‚úÖ CI/CD automatizado con GitHub Actions
- ‚úÖ Dockerizaci√≥n con multi-stage builds
- ‚úÖ Despliegue en Kubernetes con manifiestos
- ‚úÖ GitOps con ArgoCD (auto-sync y self-heal)
- ‚úÖ Cluster local con Kind
- ‚úÖ Documentaci√≥n completa

---

## üîß Requisitos Previos

### Software necesario:

- **Node.js 18+**: https://nodejs.org/
- **Git**: https://git-scm.com/
- **Docker**: https://www.docker.com/get-started
- **kubectl**: https://kubernetes.io/docs/tasks/tools/
- **Kind** (Kubernetes in Docker): https://kind.sigs.k8s.io/docs/user/quick-start/

### Cuentas necesarias:

- GitHub (https://github.com)
- Docker Hub (https://hub.docker.com)
- SonarCloud (https://sonarcloud.io)
- Snyk (https://snyk.io)

---

## ‚öôÔ∏è Instalaci√≥n y Configuraci√≥n

### 1. Clonar el repositorio

```bash
git clone https://github.com/jpalenz77/practica-final-cicd.git
cd practica-final-cicd
```

### 2. Instalar dependencias

```bash
npm install
```

### 3. Ejecutar tests localmente

```bash
# Ejecutar tests
npm test

# Ver cobertura
npm test -- --coverage

# Linting
npm run lint

# Corregir linting autom√°ticamente
npm run lint:fix
```

### 4. Ejecutar la aplicaci√≥n localmente

```bash
# Modo desarrollo (con hot-reload)
npm run dev

# Modo producci√≥n
npm start
```

La aplicaci√≥n estar√° disponible en **http://localhost:3000**

### 5. Ejecutar con Docker

```bash
# Construir imagen
docker build -t my-api-cicd:latest .

# Ejecutar contenedor
docker run -p 3000:3000 my-api-cicd:latest

# Probar
curl http://localhost:3000/health
```

---

## üåê Configuraci√≥n de Servicios Externos

### 1. Docker Hub

#### Crear cuenta y repositorio:

1. Reg√≠strate en https://hub.docker.com
2. Crea un repositorio p√∫blico llamado `my-api-cicd`

#### Crear Access Token:

1. Ve a **Account Settings** ‚Üí **Security**
2. Clic en **New Access Token**
3. Nombre: `github-actions`
4. Permisos: **Read, Write, Delete**
5. **Genera el token y c√≥pialo** (empieza con `dckr_pat_`)

### 2. SonarCloud

#### Crear cuenta y proyecto:

1. Ve a https://sonarcloud.io
2. Login con GitHub
3. Clic en **"+"** ‚Üí **Analyze new project**
4. Selecciona tu repositorio `practica-final-cicd`
5. Elige **"With GitHub Actions"**
6. **Copia el SONAR_TOKEN** que te proporciona

#### Configurar organizaci√≥n:

1. En SonarCloud, ve a **My Organizations**
2. Copia el **Organization Key** (ser√° algo como `moids77`)
3. Actualiza `sonar-project.properties` con tu informaci√≥n:

```properties
sonar.projectKey=tu-usuario_practica-final-cicd
sonar.organization=tu-org-key
```

#### ‚ö†Ô∏è Importante: Deshabilitar an√°lisis autom√°tico

1. Ve a tu proyecto en SonarCloud
2. **Administration** ‚Üí **Analysis Method**
3. **Desactiva "Automatic Analysis"**

### 3. Snyk

#### Crear cuenta y obtener token:

1. Ve a https://snyk.io
2. Login con GitHub
3. Clic en tu avatar ‚Üí **Account settings**
4. En **General**, baja hasta **Auth Token**
5. Clic en **"Click to show"** y **copia el token**

#### Importar proyecto (opcional):

1. **Add project** ‚Üí **GitHub**
2. Selecciona `practica-final-cicd`
3. Snyk analizar√° autom√°ticamente tus dependencias

---

## üîê Configuraci√≥n de GitHub Secrets

Ve a tu repositorio en GitHub ‚Üí **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**

Crea los siguientes secrets:

| Secret Name | Valor | Descripci√≥n |
|------------|-------|-------------|
| `DOCKERHUB_USERNAME` | Tu usuario de Docker Hub | Usuario para login en Docker Hub |
| `DOCKERHUB_TOKEN` | Token de Docker Hub | Token que copiaste (empieza con `dckr_pat_`) |
| `SONAR_TOKEN` | Token de SonarCloud | Token para an√°lisis est√°tico |
| `SNYK_TOKEN` | Token de Snyk | Token para an√°lisis de vulnerabilidades |

**C√≥mo a√±adir un secret:**
1. Clic en **"New repository secret"**
2. Name: (nombre del secret)
3. Secret: (valor del secret)
4. Clic en **"Add secret"**

---

## ‚ò∏Ô∏è Configuraci√≥n del Cluster Kubernetes

### 1. Instalar Kind

**Linux/WSL:**
```bash
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
```

**macOS:**
```bash
brew install kind
```

**Windows (PowerShell):**
```powershell
choco install kind
```

### 2. Instalar kubectl

**Linux:**
```bash
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
```

**macOS:**
```bash
brew install kubectl
```

**Windows:**
```powershell
choco install kubernetes-cli
```

### 3. Crear cluster de Kind

```bash
# Crear cluster con la configuraci√≥n del proyecto
kind create cluster --config kind-config.yaml

# Verificar que funciona
kubectl cluster-info --context kind-my-api-cicd-cluster
kubectl get nodes
```

Deber√≠as ver un nodo en estado **Ready**.

### 4. Desplegar la aplicaci√≥n manualmente (prueba)

```bash
# Aplicar manifiestos
kubectl apply -k k8s/

# Ver el progreso
kubectl get pods -n my-api-cicd -w

# Espera a que los pods est√©n "Running"
# Presiona Ctrl+C para salir
```

### 5. Verificar el despliegue

```bash
# Ver todos los recursos
kubectl get all -n my-api-cicd

# Probar la aplicaci√≥n
curl http://localhost:30080/health
curl http://localhost:30080/api/users

# Ver logs
kubectl logs -n my-api-cicd -l app=my-api-cicd
```

---

## üîÑ Configuraci√≥n de ArgoCD

### 1. Instalar ArgoCD

```bash
# Crear namespace
kubectl create namespace argocd

# Instalar ArgoCD
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Esperar a que todos los pods est√©n listos (2-3 minutos)
kubectl get pods -n argocd -w
```

Presiona `Ctrl+C` cuando todos est√©n en **Running** y **1/1 Ready**.

### 2. Exponer ArgoCD UI

```bash
# Cambiar servicio a NodePort
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'

# Configurar puerto 30000
kubectl patch svc argocd-server -n argocd --type='json' -p='[{"op": "replace", "path": "/spec/ports/0/nodePort", "value":30000}]'

# Verificar
kubectl get svc argocd-server -n argocd
```

### 3. Obtener contrase√±a de admin

```bash
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo
```

**Copia esta contrase√±a**, la necesitar√°s para hacer login.

### 4. Acceder a ArgoCD UI

1. Abre tu navegador en: **https://localhost:30000**
2. Acepta el certificado autofirmado
3. Login:
   - **Username**: `admin`
   - **Password**: (la que copiaste en el paso anterior)

### 5. Configurar acceso al repositorio privado

#### Crear GitHub Personal Access Token:

1. Ve a GitHub ‚Üí **Settings** ‚Üí **Developer settings**
2. **Personal access tokens** ‚Üí **Tokens (classic)**
3. **Generate new token (classic)**
4. Configuraci√≥n:
   - **Note**: `argocd-repository-access`
   - **Expiration**: `90 days` o sin expiraci√≥n
   - **Scopes**: ‚úÖ **repo** (marca todo)
5. **Generate token** y **copia el token** (empieza con `ghp_`)

#### Configurar en ArgoCD UI:

1. En ArgoCD UI, ve a **Settings** (‚öôÔ∏è) ‚Üí **Repositories**
2. Clic en **+ Connect Repo**
3. Configurar:
   - **Method**: `HTTPS`
   - **Type**: `git`
   - **Project**: `default`
   - **Repository URL**: `https://github.com/jpalenz77/practica-final-cicd`
   - **Username**: `jpalenz77` (tu usuario de GitHub)
   - **Password**: (pega el token `ghp_...`)
4. Clic en **CONNECT**
5. Debe decir **Connection Status: Successful** ‚úÖ

### 6. Crear aplicaci√≥n en ArgoCD

#### Opci√≥n A: Desde la UI (Visual)

1. Ve a la p√°gina principal de ArgoCD
2. Clic en **+ NEW APP**
3. Configurar:

**GENERAL:**
- **Application Name**: `my-api-cicd`
- **Project**: `default`
- **Sync Policy**: `Automatic`
  - ‚úÖ **PRUNE RESOURCES**
  - ‚úÖ **SELF HEAL**

**SOURCE:**
- **Repository URL**: `https://github.com/jpalenz77/practica-final-cicd`
- **Revision**: `main`
- **Path**: `k8s`

**DESTINATION:**
- **Cluster URL**: `https://kubernetes.default.svc`
- **Namespace**: `my-api-cicd`

4. Clic en **CREATE**

#### Opci√≥n B: Desde el archivo (GitOps completo)

```bash
# Aplicar la aplicaci√≥n de ArgoCD desde el repositorio
kubectl apply -f argocd/application.yaml

# Ver el estado
kubectl get application -n argocd
```

### 7. Verificar ArgoCD

En la UI deber√≠as ver:
- üü¢ **Synced** (sincronizado con Git)
- üíö **Healthy** (todos los recursos saludables)

Clic en la aplicaci√≥n para ver el diagrama visual de recursos.

---

## üìö API Endpoints

### Health Check
```bash
GET /health
```

**Respuesta:**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-22T12:00:00.000Z"
}
```

### Informaci√≥n de la API
```bash
GET /
```

**Respuesta:**
```json
{
  "message": "API CI/CD - Node.js + Express",
  "version": "1.0.0",
  "status": "running"
}
```

### Usuarios

#### Obtener todos los usuarios
```bash
GET /api/users
```

#### Obtener usuario por ID
```bash
GET /api/users/:id
```

#### Crear nuevo usuario
```bash
POST /api/users
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com"
}
```

#### Actualizar usuario
```bash
PUT /api/users/:id
Content-Type: application/json

{
  "name": "Jane Doe",
  "email": "jane@example.com"
}
```

#### Eliminar usuario
```bash
DELETE /api/users/:id
```

---

## üîÑ CI/CD Pipeline

El pipeline se ejecuta autom√°ticamente en cada push y pull request.

### Flujo del Pipeline:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     GitHub Actions                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Checkout Code                                           ‚îÇ
‚îÇ  2. Setup Node.js                                           ‚îÇ
‚îÇ  3. Install Dependencies                                    ‚îÇ
‚îÇ  4. Run Linting (ESLint)                                    ‚îÇ
‚îÇ  5. Run Tests (Jest)                                        ‚îÇ
‚îÇ  6. Generate Coverage Report                                ‚îÇ
‚îÇ  7. SonarCloud Analysis                                     ‚îÇ
‚îÇ  8. Snyk Vulnerability Scan                                 ‚îÇ
‚îÇ  9. [Solo en main] Build Docker Image                       ‚îÇ
‚îÇ 10. [Solo en main] Push to Docker Hub                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        ArgoCD                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Detecta cambio en repositorio (polling cada 3 min)     ‚îÇ
‚îÇ  2. Compara estado actual vs deseado                        ‚îÇ
‚îÇ  3. Sincroniza autom√°ticamente                              ‚îÇ
‚îÇ  4. Despliega en Kubernetes                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Kubernetes                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Pull nueva imagen de Docker Hub                         ‚îÇ
‚îÇ  2. Crear nuevos pods                                       ‚îÇ
‚îÇ  3. Rolling update (cero downtime)                          ‚îÇ
‚îÇ  4. Health checks (liveness & readiness)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Jobs del Pipeline:

#### Job 1: Build and Test (todas las ramas)
- ‚úÖ Build de la aplicaci√≥n
- ‚úÖ Ejecuci√≥n de tests unitarios
- ‚úÖ Generaci√≥n de informe de cobertura
- ‚úÖ Linting con ESLint
- ‚úÖ An√°lisis est√°tico con SonarCloud
- ‚úÖ An√°lisis de vulnerabilidades con Snyk

#### Job 2: Build Docker (solo rama main)
- ‚úÖ Build de imagen Docker
- ‚úÖ Push a Docker Hub con tags:
  - `latest`
  - `main-sha-xxxxxxx`
- ‚úÖ Test de la imagen Docker

---

## üîÑ Flujo de Trabajo GitOps

### Hacer un cambio en la aplicaci√≥n:

#### 1. Crear una rama feature

```bash
git checkout develop
git pull origin develop
git checkout -b feature/nueva-funcionalidad
```

#### 2. Hacer cambios en el c√≥digo

Por ejemplo, actualizar la versi√≥n en `src/app.js`:

```javascript
app.get('/', (req, res) => {
  res.json({
    message: 'API CI/CD - Node.js + Express',
    version: '2.0.0',  // Cambiar versi√≥n
    status: 'running'
  });
});
```

#### 3. Ejecutar tests localmente

```bash
npm test
npm run lint
```

#### 4. Commitear y pushear

```bash
git add .
git commit -m "feat: update version to 2.0.0"
git push origin feature/nueva-funcionalidad
```

#### 5. Crear Pull Request

1. Ve a GitHub
2. Crea un Pull Request de `feature/nueva-funcionalidad` ‚Üí `develop`
3. GitHub Actions ejecutar√° el pipeline
4. Revisa los checks (tests, linting, SonarCloud, Snyk)
5. Si todo est√° ‚úÖ, haz **Merge**

#### 6. Merge a main (Despliegue a producci√≥n)

```bash
git checkout main
git pull origin main
git merge develop
git push origin main
```

#### 7. Observar el despliegue autom√°tico

**GitHub Actions:**
1. Ve a **Actions** en GitHub
2. Ver√°s el workflow ejecut√°ndose
3. Espera a que termine (build + push a Docker Hub)

**ArgoCD:**
1. Ve a ArgoCD UI: https://localhost:30000
2. En 1-3 minutos, ArgoCD detecta el cambio
3. Sincroniza autom√°ticamente
4. Los pods se recrean con la nueva versi√≥n

**Kubernetes:**
```bash
# Ver pods recre√°ndose
kubectl get pods -n my-api-cicd -w

# Probar nueva versi√≥n
curl http://localhost:30080/
```

---

## ‚úÖ Verificaci√≥n Completa

### 1. GitHub Actions

1. Ve a https://github.com/jpalenz77/practica-final-cicd/actions
2. Deber√≠as ver workflows exitosos con ‚úÖ

### 2. SonarCloud

1. Ve a https://sonarcloud.io
2. Selecciona tu proyecto `practica-final-cicd`
3. Revisa:
   - Quality Gate Status
   - Coverage
   - Code Smells
   - Bugs
   - Security Hotspots

### 3. Snyk

1. Ve a https://app.snyk.io
2. Selecciona tu proyecto
3. Revisa vulnerabilidades detectadas

### 4. Docker Hub

1. Ve a https://hub.docker.com/r/moids77/my-api-cicd
2. Verifica tags:
   - `latest`
   - `main-sha-xxxxxxx`

### 5. Kubernetes

```bash
# Ver recursos
kubectl get all -n my-api-cicd

# Probar aplicaci√≥n
curl http://localhost:30080/health
curl http://localhost:30080/api/users

# Ver logs
kubectl logs -n my-api-cicd -l app=my-api-cicd --tail=50
```

### 6. ArgoCD

- **UI**: https://localhost:30000
- **Estado**: üü¢ Synced y üíö Healthy
- Ver diagrama de recursos

---

## üèóÔ∏è Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   GitHub    ‚îÇ
‚îÇ Repository  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ git push
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       GitHub Actions                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Build  ‚îÇ ‚îÇ Test   ‚îÇ ‚îÇ Analyze ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚Üì
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ  Docker Hub    ‚îÇ
      ‚îÇ  (Registry)    ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚Üì
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ    ArgoCD      ‚îÇ
      ‚îÇ   (GitOps)     ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚Üì
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ  Kubernetes    ‚îÇ
      ‚îÇ   (Kind)       ‚îÇ
      ‚îÇ                ‚îÇ
      ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
      ‚îÇ  ‚îÇ   Pods   ‚îÇ  ‚îÇ
      ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ Estructura del Proyecto

```
practica-final-cicd/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci-cd.yml              # Pipeline de GitHub Actions
‚îú‚îÄ‚îÄ argocd/
‚îÇ   ‚îú‚îÄ‚îÄ application.yaml           # Aplicaci√≥n de ArgoCD
‚îÇ   ‚îî‚îÄ‚îÄ README.md                  # Documentaci√≥n de ArgoCD
‚îú‚îÄ‚îÄ k8s/                           # Manifiestos de Kubernetes
‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml             # Namespace
‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml            # Deployment con 2 r√©plicas
‚îÇ   ‚îú‚îÄ‚îÄ service.yaml               # Service NodePort
‚îÇ   ‚îú‚îÄ‚îÄ kustomization.yaml         # Kustomize config
‚îÇ   ‚îî‚îÄ‚îÄ README.md                  # Documentaci√≥n K8s
‚îú‚îÄ‚îÄ src/                           # C√≥digo fuente
‚îÇ   ‚îú‚îÄ‚îÄ app.js                     # Configuraci√≥n de Express
‚îÇ   ‚îú‚îÄ‚îÄ server.js                  # Punto de entrada
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ users.js               # Rutas de usuarios
‚îú‚îÄ‚îÄ tests/                         # Tests unitarios
‚îÇ   ‚îî‚îÄ‚îÄ users.test.js              # Tests de la API
‚îú‚îÄ‚îÄ coverage/                      # Informe de cobertura (generado)
‚îú‚îÄ‚îÄ .eslintrc.json                 # Configuraci√≥n ESLint
‚îú‚îÄ‚îÄ .gitignore                     # Archivos ignorados por Git
‚îú‚îÄ‚îÄ Dockerfile                     # Multi-stage Docker build
‚îú‚îÄ‚îÄ kind-config.yaml               # Configuraci√≥n de Kind
‚îú‚îÄ‚îÄ package.json                   # Dependencias y scripts
‚îú‚îÄ‚îÄ package-lock.json              # Lock file de dependencias
‚îú‚îÄ‚îÄ sonar-project.properties       # Configuraci√≥n SonarCloud
‚îî‚îÄ‚îÄ README.md                      # Este archivo
```

---

## üîß Troubleshooting

### Pipeline falla en tests

```bash
# Ejecutar tests localmente para ver el error
npm test

# Ver logs detallados
npm test -- --verbose
```

### Pipeline falla en SonarCloud

- Verifica que `SONAR_TOKEN` est√© configurado
- Verifica que el an√°lisis autom√°tico est√© desactivado en SonarCloud
- Verifica que `sonar-project.properties` tenga tu organizaci√≥n correcta

### Pipeline falla en Snyk

- Verifica que `SNYK_TOKEN` est√© configurado correctamente
- El token debe tener permisos de lectura

### Pipeline falla en Docker push

- Verifica `DOCKERHUB_USERNAME` y `DOCKERHUB_TOKEN`
- El token debe tener permisos de **Read & Write**
- Verifica que el repositorio existe en Docker Hub

### Pods en ImagePullBackOff

```bash
# Ver el error
kubectl describe pod -n my-api-cicd -l app=my-api-cicd

# Verifica que la imagen exista en Docker Hub
# Verifica que el deployment.yaml tenga la imagen correcta
kubectl get deployment -n my-api-cicd my-api-cicd -o jsonpath='{.spec.template.spec.containers[0].image}'
```

### Pods en CrashLoopBackOff

```bash
# Ver logs del contenedor
kubectl logs -n my-api-cicd -l app=my-api-cicd --tail=100

# Ver eventos
kubectl get events -n my-api-cicd --sort-by='.lastTimestamp'
```

### ArgoCD no puede acceder al repositorio

- Verifica que las credenciales est√©n configuradas en Settings ‚Üí Repositories
- El token de GitHub debe tener permisos de **repo**
- Si el repo es privado, aseg√∫rate de que el token sea v√°lido

### ArgoCD no sincroniza autom√°ticamente

```bash
# Forzar sincronizaci√≥n
kubectl patch application my-api-cicd -n argocd --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"normal"}}}'

# O desde UI: Clic en REFRESH ‚Üí SYNC
```

### Kind no puede crear el cluster

- Verifica que Docker est√© corriendo
- En WSL, verifica que Docker Desktop tenga WSL integration activada
- Intenta con un cluster m√°s simple: `kind create cluster`

### Aplicaci√≥n no responde en localhost:30080

```bash
# Verificar que el servicio est√© correcto
kubectl get svc -n my-api-cicd

# Verificar que Kind est√© mapeando el puerto
docker ps | grep kind

# Si no funciona, eliminar y recrear el cluster
kind delete cluster --name my-api-cicd-cluster
kind create cluster --config kind-config.yaml
```

---

## üîó Enlaces Importantes

### Repositorios y Registros
- **GitHub Repository**: https://github.com/jpalenz77/practica-final-cicd
- **Docker Hub**: https://hub.docker.com/r/moids77/my-api-cicd

### An√°lisis y Calidad
- **SonarCloud**: https://sonarcloud.io/project/overview?id=jpalenz77_practica-final-cicd
- **Snyk**: Ver en logs de GitHub Actions

### Interfaces Web
- **GitHub Actions**: https://github.com/jpalenz77/practica-final-cicd/actions
- **ArgoCD UI**: https://localhost:30000 (local)

### Documentaci√≥n
- **GitHub Actions**: https://docs.github.com/en/actions
- **SonarCloud**: https://docs.sonarcloud.io/
- **Snyk**: https://docs.snyk.io/
- **Kubernetes**: https://kubernetes.io/docs/
- **ArgoCD**: https://argo-cd.readthedocs.io/
- **Kind**: https://kind.sigs.k8s.io/
- **Docker**: https://docs.docker.com/
- **Express**: https://expressjs.com/
- **Jest**: https://jestjs.io/

---

## üë• Autor

**Jos√© Pablo Alenza**
- GitHub: [@jpalenz77](https://github.com/jpalenz77)
- Proyecto: [practica-final-cicd](https://github.com/jpalenz77/practica-final-cicd)

---

## üìù Licencia

ISC

---

## üéâ ¬°Felicidades!

Si has llegado hasta aqu√≠ y todo funciona, tienes:

‚úÖ Un pipeline CI/CD completo  
‚úÖ Tests automatizados  
‚úÖ An√°lisis de calidad y seguridad  
‚úÖ Despliegue continuo con GitOps  
‚úÖ Infraestructura como c√≥digo  
‚úÖ Kubernetes local funcionando  
‚úÖ Monitoreo con ArgoCD  

**¬°Has implementado un flujo DevOps profesional completo!** üöÄbadges/measure?project=jpalenz77_practica-final-cicd&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=jpalenz77_practica-final-cicd)

[![Node.js](https://img.shields.io/badge/Node.js-18+-339933?style=flat-square&logo=node.js&logoColor=white)](https://nodejs.org/)
[![Express](https://img.shields.io/badge/Express-4.18+-000000?style=flat-square&logo=express&logoColor=white)](https://expressjs.com/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=flat-square&logo=docker&logoColor=white)](https://www.docker.com/)
[![Kubernetes](https://img.shields.io/badge/Kubernetes-326CE5?style=flat-square&logo=kubernetes&logoColor=white)](https://kubernetes.io/)
[![ArgoCD](https://img.shields.io/badge/ArgoCD-EF7B4D?style=flat-square&logo=argo&logoColor=white)](https://argo-cd.readthedocs.io/)

[![GitHub Actions](https://img.shields.io/badge/GitHub_Actions-2088FF?style=flat-square&logo=github-actions&logoColor=white)](https://github.com/features/actions)
[![SonarCloud](https://img.shields.io/badge/SonarCloud-F3702A?style=flat-square&logo=sonarcloud&logoColor=white)](https://sonarcloud.io/)
[![Snyk](https://img.shields.io/badge/Snyk-4C4A73?style=flat-square&logo=snyk&logoColor=white)](https://snyk.io/)
[![Jest](https://img.shields.io/badge/Jest-C21325?style=flat-square&logo=jest&logoColor=white)](https://jestjs.io/)
[![ESLint](https://img.shields.io/badge/ESLint-4B32C3?style=flat-square&logo=eslint&logoColor=white)](https://eslint.org/)

API REST desarrollada con Node.js y Express que implementa un pipeline completo de CI/CD con despliegue autom√°tico en Kubernetes usando ArgoCD.

## üöÄ Caracter√≠sticas

- API REST con CRUD de usuarios
- Tests unitarios con Jest
- Cobertura de c√≥digo
- Linting con ESLint
- An√°lisis est√°tico de c√≥digo con SonarCloud
- An√°lisis de vulnerabilidades con Snyk
- CI/CD con GitHub Actions
- Dockerizaci√≥n con multi-stage builds
- Despliegue autom√°tico en Kubernetes con ArgoCD
- GitOps workflow

## üìã Requisitos

- Node.js 18+
- Docker
- kubectl
- Kind (Kubernetes in Docker)

## üõ†Ô∏è Instalaci√≥n local

```bash
# Clonar el repositorio
git clone https://github.com/jpalenz77/practica-final-cicd
cd practica-final-cicd

# Instalar dependencias
npm install

# Ejecutar tests
npm test

# Ejecutar aplicaci√≥n
npm start
```

## üê≥ Docker

```bash
# Construir imagen
docker build -t my-api-cicd:latest .

# Ejecutar contenedor
docker run -p 3000:3000 my-api-cicd:latest
```

**Imagen en Docker Hub**: https://hub.docker.com/r/moids77/my-api-cicd

## ‚ò∏Ô∏è Despliegue en Kubernetes

### Con Kind (local)

```bash
# Crear cluster
kind create cluster --config kind-config.yaml

# Aplicar manifiestos
kubectl apply -k k8s/

# Verificar
kubectl get all -n my-api-cicd
```

### Con ArgoCD

1. Instalar ArgoCD:
```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

2. Acceder a ArgoCD UI:
```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort"}}'
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

3. Crear aplicaci√≥n desde UI en https://localhost:30000

## üìö API Endpoints

### Health Check
```
GET /health
```

### Usuarios

```
GET    /api/users      - Obtener todos los usuarios
GET    /api/users/:id  - Obtener usuario por ID
POST   /api/users      - Crear nuevo usuario
PUT    /api/users/:id  - Actualizar usuario
DELETE /api/users/:id  - Eliminar usuario
```

## üîÑ CI/CD Pipeline

El pipeline se ejecuta autom√°ticamente en cada push y pull request:

### En todas las ramas:
- ‚úÖ Build de la aplicaci√≥n
- ‚úÖ Ejecuci√≥n de tests con cobertura
- ‚úÖ Linting con ESLint
- ‚úÖ An√°lisis est√°tico con SonarCloud
- ‚úÖ An√°lisis de vulnerabilidades con Snyk

### Solo en rama main:
- ‚úÖ Build de imagen Docker
- ‚úÖ Push a Docker Hub
- ‚úÖ Despliegue autom√°tico v√≠a ArgoCD

## üîó Enlaces

- **Repositorio**: https://github.com/jpalenz77/practica-final-cicd
- **Docker Hub**: https://hub.docker.com/r/moids77/my-api-cicd
- **SonarCloud**: https://sonarcloud.io/project/overview?id=jpalenz77_practica-final-cicd
- **Snyk**: (ver en GitHub Actions logs)

## üèóÔ∏è Arquitectura

```
GitHub ‚Üí GitHub Actions ‚Üí Docker Hub ‚Üí ArgoCD ‚Üí Kubernetes (Kind)
   ‚Üì
SonarCloud + Snyk
```

## üìÅ Estructura del Proyecto

```
.
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci-cd.yml           # Pipeline de CI/CD
‚îú‚îÄ‚îÄ k8s/                        # Manifiestos de Kubernetes
‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml
‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml
‚îÇ   ‚îú‚îÄ‚îÄ service.yaml
‚îÇ   ‚îî‚îÄ‚îÄ kustomization.yaml
‚îú‚îÄ‚îÄ src/                        # C√≥digo fuente
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îú‚îÄ‚îÄ server.js
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îú‚îÄ‚îÄ tests/                      # Tests
‚îú‚îÄ‚îÄ Dockerfile                  # Multi-stage build
‚îú‚îÄ‚îÄ kind-config.yaml           # Configuraci√≥n de Kind
‚îî‚îÄ‚îÄ sonar-project.properties   # Configuraci√≥n de SonarCloud
```

## üß™ Testing

```bash
# Ejecutar tests
npm test

# Tests con watch
npm run test:watch

# Ver cobertura
npm test -- --coverage
```

## üîç An√°lisis de C√≥digo

### SonarCloud
- Calidad de c√≥digo
- Code smells
- Bugs
- Vulnerabilidades de seguridad
- Cobertura de tests

### Snyk
- Vulnerabilidades en dependencias
- An√°lisis de contenedor Docker
- Sugerencias de fixes

## üìù Git Flow

- `main`: Rama de producci√≥n (despliegues autom√°ticos)
- `develop`: Rama de desarrollo
- `feature/*`: Nuevas funcionalidades

## üë• Autor

Jos√© Pablo Alenza - [GitHub](https://github.com/jpalenz77)

## üìù Licencia

ISC