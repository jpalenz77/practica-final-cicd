# ============================================
# Pipeline CI/CD Completo
# ============================================
# Este workflow automatiza todo el proceso de integraciÃ³n y despliegue continuo
# Incluye: tests, anÃ¡lisis de calidad, seguridad y construcciÃ³n de imÃ¡genes Docker

name: ðŸš€ Pipeline CI/CD

# ============================================
# Eventos que disparan el pipeline
# ============================================
on:
  # Se ejecuta cuando hay un push a estas ramas
  push:
    branches: [ main, develop ]
  
  # Se ejecuta cuando hay un pull request hacia estas ramas
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================
  # JOB 1: ConstrucciÃ³n, Tests y AnÃ¡lisis
  # ============================================
  # Este job se ejecuta SIEMPRE en todas las ramas
  build-and-test:
    name: ðŸ§ª ConstrucciÃ³n, Tests y AnÃ¡lisis de Calidad
    runs-on: ubuntu-latest  # MÃ¡quina virtual Ubuntu mÃ¡s reciente
    
    steps:
      # ----------------------------------------
      # PASO 1: Descargar el cÃ³digo del repositorio
      # ----------------------------------------
      - name: ðŸ“¥ Descargar cÃ³digo del repositorio
        uses: actions/checkout@v4

      # ----------------------------------------
      # PASO 2: Configurar Node.js versiÃ³n 18
      # ----------------------------------------
      - name: âš™ï¸ Configurar Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # VersiÃ³n de Node.js a utilizar

      # ----------------------------------------
      # PASO 3: Instalar dependencias del proyecto
      # ----------------------------------------
      # npm ci es mÃ¡s rÃ¡pido y confiable que npm install para CI/CD
      # porque instala exactamente las versiones del package-lock.json
      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      # ----------------------------------------
      # PASO 4: Ejecutar linting (anÃ¡lisis de cÃ³digo)
      # ----------------------------------------
      # ESLint verifica que el cÃ³digo siga las reglas de estilo
      # y detecta errores potenciales
      - name: ðŸ” Ejecutar anÃ¡lisis de cÃ³digo (ESLint)
        run: npm run lint

      # ----------------------------------------
      # PASO 5: Ejecutar tests unitarios con cobertura
      # ----------------------------------------
      # Jest ejecuta todos los tests y genera un informe de cobertura
      # que indica quÃ© porcentaje del cÃ³digo estÃ¡ testeado
      - name: âœ… Ejecutar tests unitarios
        run: npm test

      # ----------------------------------------
      # PASO 6: Subir informe de cobertura como artefacto
      # ----------------------------------------
      # El informe se guarda como artefacto descargable en GitHub
      - name: ðŸ“Š Subir informe de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report  # Nombre del artefacto
          path: coverage/        # Carpeta que contiene el informe

      # ----------------------------------------
      # PASO 7: Mostrar resumen de cobertura en GitHub
      # ----------------------------------------
      # AÃ±ade un resumen visual de la cobertura en la pÃ¡gina del workflow
      - name: ðŸ“ˆ Mostrar resumen de cobertura
        run: |
          echo "### ðŸ“Š Resumen de Cobertura de Tests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.txt || echo "No se encontrÃ³ el resumen de cobertura"
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ----------------------------------------
      # PASO 8: AnÃ¡lisis estÃ¡tico con SonarCloud
      # ----------------------------------------
      # SonarCloud analiza la calidad del cÃ³digo, detecta bugs,
      # vulnerabilidades y code smells (cÃ³digo con mal olor)
      - name: ðŸ”¬ AnÃ¡lisis de calidad con SonarCloud
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}         # Token de autenticaciÃ³n
          SONAR_HOST_URL: https://sonarcloud.io          # URL de SonarCloud

      # ----------------------------------------
      # PASO 9: AnÃ¡lisis de vulnerabilidades con Snyk (Test)
      # ----------------------------------------
      # Snyk escanea las dependencias en busca de vulnerabilidades conocidas
      # continue-on-error: true permite que el pipeline continÃºe aunque encuentre vulnerabilidades
      - name: ðŸ›¡ï¸ Escanear vulnerabilidades con Snyk
        uses: snyk/actions/node@master
        continue-on-error: true  # No falla el pipeline si encuentra vulnerabilidades
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test  # Comando para analizar vulnerabilidades
          
      # ----------------------------------------
      # PASO 10: Monitorear proyecto en Snyk
      # ----------------------------------------
      # Este comando envÃ­a informaciÃ³n a Snyk para monitoreo continuo
      # y recibir alertas de nuevas vulnerabilidades
      - name: ðŸ“¡ Enviar proyecto a monitoreo de Snyk
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor  # Comando para monitorear el proyecto

      # ----------------------------------------
      # PASO 11: Resumen del Job Build & Test
      # ----------------------------------------
      - name: ðŸ“‹ Generar resumen del job
        if: always()
        run: |
          echo "## âœ… Build y Tests Completados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Paso | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ InstalaciÃ³n de dependencias | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Linting (ESLint) | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Tests unitarios | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ SonarCloud | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Snyk | âœ… Completado |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š MÃ©tricas" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura**: Ver secciÃ³n anterior" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Gate**: Verificar en [SonarCloud](https://sonarcloud.io)" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilidades**: Verificar en [Snyk](https://app.snyk.io)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: ConstrucciÃ³n y PublicaciÃ³n de Docker
  # ============================================
  # Este job SOLO se ejecuta en la rama 'main' despuÃ©s de un push exitoso
  build-docker:
    name: ðŸ³ ConstrucciÃ³n y PublicaciÃ³n de Imagen Docker
    runs-on: ubuntu-latest
    
    # Este job depende de que build-and-test termine exitosamente
    needs: build-and-test
    
    # Solo se ejecuta si:
    # 1. La rama es 'main'
    # 2. El evento es un 'push' (no un pull request)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # ----------------------------------------
      # PASO 1: Descargar el cÃ³digo
      # ----------------------------------------
      - name: ðŸ“¥ Descargar cÃ³digo del repositorio
        uses: actions/checkout@v4

      # ----------------------------------------
      # PASO 2: Configurar Docker Buildx
      # ----------------------------------------
      # Buildx es una herramienta avanzada de Docker para construir imÃ¡genes
      # con caracterÃ­sticas como multi-plataforma y cachÃ© mejorado
      - name: ðŸ”§ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------
      # PASO 3: Login en Docker Hub
      # ----------------------------------------
      # Autenticarse en Docker Hub para poder hacer push de la imagen
      - name: ðŸ” Iniciar sesiÃ³n en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Usuario de Docker Hub
          password: ${{ secrets.DOCKERHUB_TOKEN }}     # Token de acceso

      # ----------------------------------------
      # PASO 4: Extraer metadatos para las etiquetas
      # ----------------------------------------
      # Genera automÃ¡ticamente las etiquetas (tags) para la imagen Docker
      # Ejemplo: latest, main-sha-abc123
      - name: ðŸ·ï¸ Generar etiquetas para la imagen
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/my-api-cicd
          tags: |
            type=sha,prefix={{branch}}-    # Tag con el hash del commit
            type=raw,value=latest          # Tag 'latest'

      # ----------------------------------------
      # PASO 5: Construir y publicar imagen Docker
      # ----------------------------------------
      # Construye la imagen usando el Dockerfile y la sube a Docker Hub
      # Utiliza cachÃ© de GitHub Actions para acelerar builds futuros
      - name: ðŸ—ï¸ Construir y publicar imagen Docker
        uses: docker/build-push-action@v5
        with:
          context: .                                    # Usar el directorio actual
          push: true                                    # Subir la imagen a Docker Hub
          tags: ${{ steps.meta.outputs.tags }}         # Tags generadas anteriormente
          labels: ${{ steps.meta.outputs.labels }}     # Etiquetas de metadatos
          cache-from: type=gha                          # Usar cachÃ© de GitHub Actions
          cache-to: type=gha,mode=max                   # Guardar cachÃ© completa

      # ----------------------------------------
      # PASO 6: Probar la imagen Docker
      # ----------------------------------------
      # Descarga la imagen reciÃ©n publicada y verifica que funcione correctamente
      - name: ðŸ§ª Probar imagen Docker
        run: |
          # Descargar la imagen desde Docker Hub
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/my-api-cicd:latest
          
          # Ejecutar contenedor en segundo plano
          docker run -d -p 3000:3000 --name test-container ${{ secrets.DOCKERHUB_USERNAME }}/my-api-cicd:latest
          
          # Esperar 5 segundos a que la app se inicie
          sleep 5
          
          # Hacer peticiÃ³n al health check - falla si no responde correctamente
          curl -f http://localhost:3000/health || exit 1
          
          # Detener y eliminar el contenedor de prueba
          docker stop test-container
          docker rm test-container

      # ----------------------------------------
      # PASO 7: Mostrar informaciÃ³n del build
      # ----------------------------------------
      # AÃ±ade un resumen del build exitoso en la pÃ¡gina del workflow
      - name: ðŸ“ Mostrar informaciÃ³n del build
        run: |
          echo "## ðŸ³ Build de Docker Exitoso âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Detalles de la Imagen" >> $GITHUB_STEP_SUMMARY
          echo "| Propiedad | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Imagen** | \`${{ secrets.DOCKERHUB_USERNAME }}/my-api-cicd:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA del commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Rama** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Autor** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Enlaces" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver imagen en Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/my-api-cicd)" >> $GITHUB_STEP_SUMMARY
          echo "- [Ver commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Pasos Completados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imagen construida correctamente" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Imagen publicada en Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health check verificado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸš€ La imagen estÃ¡ lista para ser desplegada por ArgoCD" >> $GITHUB_STEP_SUMMARY